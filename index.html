<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoLã‚¯ã‚¤ã‚º - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --gold: #C89B3C; --dark-blue: #0A1428; --blue: #0BC4E2;
            --purple: #A855F7; --red: #EF4444; --green: #10B981; --orange: #F97316;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #0A1428 0%, #1a2744 50%, #0A1428 100%);
            color: white; min-height: 100vh; overflow-x: hidden;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(11, 196, 226, 0.15) 0%, transparent 50%);
            pointer-events: none; z-index: 0;
        }
        .container { max-width: 100vw; min-height: 100vh; padding: 1rem; position: relative; z-index: 1; }
        h1 { font-family: 'Orbitron', sans-serif; font-size: clamp(1.5rem, 4vw, 2rem); text-align: center; margin-bottom: 0.3rem;
            background: linear-gradient(135deg, var(--gold) 0%, var(--blue) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            text-transform: uppercase; letter-spacing: 2px; }
        .subtitle { text-align: center; color: var(--blue); font-size: clamp(0.8rem, 2vw, 1rem); margin-bottom: 1rem; letter-spacing: 1px; }
        .screen { display: none; }
        .screen.active { display: block; }
        .setup-card, .lobby-card {
            background: rgba(26, 39, 68, 0.8); border: 2px solid var(--gold); border-radius: 15px;
            padding: 1.5rem; backdrop-filter: blur(10px); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 700px; margin: 0 auto; max-height: 85vh; overflow-y: auto;
        }
        .input-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.4rem; color: var(--gold); font-weight: 700; font-size: 0.9rem; }
        input, select { width: 100%; padding: 0.6rem; background: rgba(10, 20, 40, 0.7); border: 2px solid var(--blue);
            border-radius: 8px; color: white; font-size: 0.9rem; }
        input:focus, select:focus { outline: none; border-color: var(--gold); }
        .btn { padding: 0.8rem 2rem; background: linear-gradient(135deg, var(--gold) 0%, #d4af37 100%);
            border: none; border-radius: 10px; color: var(--dark-blue); font-size: 1rem; font-weight: 700;
            cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px; font-family: 'Orbitron', sans-serif; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%); color: white; }
        .category-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem; margin-top: 0.8rem; }
        .category-option { padding: 0.8rem; background: rgba(10, 20, 40, 0.7); border: 2px solid var(--blue); border-radius: 8px;
            cursor: pointer; transition: all 0.3s; text-align: center; font-size: 0.85rem; }
        .category-option:hover { transform: translateY(-2px); border-color: var(--gold); }
        .category-option.selected { background: linear-gradient(135deg, var(--gold) 0%, #d4af37 100%); border-color: var(--gold); color: var(--dark-blue); }
        .quiz-layout { display: grid; grid-template-columns: 1fr 260px; gap: 0.8rem; height: calc(100vh - 80px); max-height: calc(100vh - 80px); }
        .quiz-main { display: flex; flex-direction: column; gap: 0.5rem; min-height: 0; overflow: hidden; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center;
            background: rgba(26, 39, 68, 0.8); border: 2px solid var(--gold); border-radius: 10px;
            padding: 0.5rem 0.8rem; flex-shrink: 0; }
        .round-info { font-family: 'Orbitron', sans-serif; font-size: 1rem; color: var(--gold); }
        .timer { font-family: 'Orbitron', sans-serif; font-size: 1.3rem; color: var(--blue); min-width: 50px; text-align: center; }
        .timer.warning { color: var(--red); animation: pulse 0.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .question-section { flex: 1; background: rgba(26, 39, 68, 0.9); border: 2px solid var(--purple); border-radius: 12px;
            padding: 0.8rem 1rem; display: flex; flex-direction: column; gap: 0.5rem; min-height: 0; overflow: hidden; }
        .question-image { max-width: 100%; max-height: 140px; object-fit: cover; border: 2px solid var(--gold);
            border-radius: 8px; margin: 0 auto; display: block; flex-shrink: 0; }
        .question-text { font-size: clamp(1rem, 2.5vw, 1.2rem); font-weight: 700; text-align: center; line-height: 1.4; flex-shrink: 0; }
        .answer-section { display: flex; flex-direction: column; gap: 0.5rem; min-height: 0; flex: 1; overflow: hidden; }
        .answer-input-area { background: rgba(10, 20, 40, 0.5); border: 2px solid var(--gold); border-radius: 8px;
            padding: 0.6rem 1rem; min-height: 50px; display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem; font-weight: 700; color: var(--gold); text-align: center; word-break: break-all; flex-shrink: 0; }
        .choice-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        .choice-btn { padding: 0.7rem 0.8rem; background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
            border: 2px solid transparent; border-radius: 8px; color: white; font-size: 1rem; font-weight: 700;
            cursor: pointer; transition: all 0.3s; }
        .choice-btn:hover:not(:disabled) { transform: scale(1.05); border-color: var(--gold); }
        .choice-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: scale(1); }
        .combo-keys { display: flex; flex-wrap: wrap; gap: 0.4rem; justify-content: center; margin: 0.5rem 0; }
        .combo-key-btn { padding: 0.5rem 0.9rem; background: rgba(10, 20, 40, 0.8); border: 2px solid var(--blue);
            border-radius: 8px; color: white; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; font-family: 'Orbitron', sans-serif; }
        .combo-key-btn:hover:not(:disabled) { transform: scale(1.08); border-color: var(--gold); box-shadow: 0 0 15px rgba(200, 155, 60, 0.5); }
        .combo-key-btn:disabled { opacity: 0.4; cursor: default; }
        .combo-preview { background: rgba(10, 20, 40, 0.9); border: 2px solid var(--purple); border-radius: 8px;
            padding: 0.6rem; min-height: 45px; display: flex; align-items: center; justify-content: center; gap: 0.4rem;
            flex-wrap: wrap; font-family: 'Orbitron', sans-serif; font-size: 1.1rem; }
        .combo-preview-item { padding: 0.4rem 0.8rem; background: var(--gold); color: var(--dark-blue); border-radius: 8px; }
        .submit-combo-btn { margin-top: 1rem; padding: 1rem 2rem; font-size: 1.2rem; }
        .sidebar { display: flex; flex-direction: column; gap: 0.8rem; overflow-y: auto; min-height: 0; }
        .scoreboard { background: rgba(26, 39, 68, 0.9); border: 2px solid var(--gold); border-radius: 10px; padding: 1rem; flex-shrink: 0; }
        .scoreboard h3 { font-family: 'Orbitron', sans-serif; color: var(--gold); margin-bottom: 0.8rem; text-align: center; font-size: 1.1rem; }
        .score-item { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem; margin-bottom: 0.4rem;
            background: rgba(255, 255, 255, 0.05); border-radius: 8px; border-left: 3px solid var(--blue); }
        .score-item.first { border-left-color: var(--gold); background: rgba(200, 155, 60, 0.1); }
        .score-name { font-weight: 700; font-size: 0.9rem; }
        .score-points { color: var(--gold); font-family: 'Orbitron', sans-serif; font-size: 1rem; font-weight: 700; }
        .progress-box { background: rgba(26, 39, 68, 0.9); border: 2px solid var(--purple); border-radius: 10px; padding: 1rem; flex-shrink: 0; }
        .progress-box h3 { font-family: 'Orbitron', sans-serif; color: var(--purple); margin-bottom: 0.8rem; text-align: center; font-size: 1rem; }
        .progress-count { text-align: center; font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--blue); font-weight: 700; }
        .progress-item { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; margin-bottom: 0.4rem;
            background: rgba(255, 255, 255, 0.05); border-radius: 6px; font-size: 0.85rem; }
        .progress-item.waiting { border-left: 3px solid rgba(255,255,255,0.3); }
        .progress-item.correct { border-left: 3px solid var(--green); background: rgba(16, 185, 129, 0.15); }
        .progress-item.incorrect { border-left: 3px solid var(--red); background: rgba(239, 68, 68, 0.15); }
        .progress-badge { padding: 0.2rem 0.5rem; border-radius: 8px; font-size: 0.75rem; font-weight: 700; }
        .progress-badge.waiting { background: rgba(255,255,255,0.2); }
        .progress-badge.correct { background: var(--green); color: white; }
        .progress-badge.incorrect { background: var(--red); color: white; }
        .mistakes-info { background: rgba(239, 68, 68, 0.2); border: 1px solid var(--red); border-radius: 6px;
            padding: 0.4rem; text-align: center; margin-top: 0.3rem; font-size: 0.75rem; }
        .connection-status { position: fixed; top: 0.5rem; right: 0.5rem; background: rgba(0, 0, 0, 0.8);
            padding: 0.4rem 0.8rem; border-radius: 15px; display: flex; align-items: center; gap: 0.4rem; z-index: 100; font-size: 0.8rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); }
        .status-dot.disconnected { background: var(--red); }
        .results-card { background: rgba(26, 39, 68, 0.9); border: 3px solid var(--gold); border-radius: 15px;
            padding: 2rem; text-align: center; max-width: 600px; margin: 0 auto; }
        .trophy { font-size: 4rem; margin-bottom: 0.8rem; }
        .winner-name { font-family: 'Orbitron', sans-serif; font-size: 2rem; color: var(--gold); margin-bottom: 1rem; }
        .results-actions { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
        .reveal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; animation: fadeIn 0.3s; }
        .reveal-title { font-size: 2rem; color: var(--gold); margin-bottom: 2rem; font-family: 'Orbitron', sans-serif; }
        .reveal-list { display: flex; flex-direction: column; gap: 1rem; max-width: 400px; width: 90%; }
        .reveal-item { padding: 1rem; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 1.2rem; }
        .reveal-item.correct { background: rgba(16, 185, 129, 0.3); border: 2px solid var(--green); }
        .reveal-item.incorrect { background: rgba(239, 68, 68, 0.3); border: 2px solid var(--red); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes flashCorrect { 0%, 100% { background: transparent; } 50% { background: rgba(16, 185, 129, 0.4); } }
        .flash-correct { animation: flashCorrect 0.5s ease-out; }
    </style>
</head>
<body>
    <div class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">æ¥ç¶šä¸­</span>
    </div>
    <div class="container">
        <h1>LoLã‚¯ã‚¤ã‚º</h1>
        <p class="subtitle">League of Legends - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦ï¼ˆå…¨å“¡åŒæ™‚å›ç­”ï¼‰</p>
        <div id="homeScreen" class="screen active">
            <div class="setup-card">
                <div class="input-group">
                    <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
                    <input type="text" id="playerName" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›" maxlength="20">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
                    <button class="btn" id="createRoomBtn">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
                    <button class="btn btn-secondary" id="joinRoomBtn">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>
                </div>
            </div>
        </div>
        <div id="joinScreen" class="screen">
            <div class="setup-card">
                <div class="input-group">
                    <label>ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰</label>
                    <input type="text" id="roomCodeInput" placeholder="6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" maxlength="6" style="text-transform: uppercase;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
                    <button class="btn btn-secondary" id="backToHomeBtn">æˆ»ã‚‹</button>
                    <button class="btn" id="joinBtn">å‚åŠ </button>
                </div>
            </div>
        </div>
        <div id="lobbyScreen" class="screen">
            <div class="lobby-card">
                <div style="background: rgba(10, 20, 40, 0.9); border: 2px solid var(--gold); border-radius: 10px; padding: 1rem; text-align: center; margin-bottom: 1rem;">
                    <div style="color: var(--blue); font-size: 0.9rem; margin-bottom: 0.3rem;">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰</div>
                    <div style="font-family: 'Orbitron', sans-serif; font-size: 2rem; color: var(--gold); letter-spacing: 6px; margin: 0.3rem 0;" id="roomCode">------</div>
                    <button id="copyCodeBtn" style="padding: 0.5rem 1.2rem; background: var(--blue); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; font-size: 0.85rem;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                </div>
                <div class="input-group" id="hostSettings">
                    <label>å‡ºé¡Œç¯„å›²è¨­å®šï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                    <div class="category-grid" id="categoryGrid">
                        <div class="category-option selected" data-category="champion">ğŸ­ ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³å</div>
                        <div class="category-option" data-category="skill">âš”ï¸ ã‚¹ã‚­ãƒ«åŠ¹æœ</div>
                        <div class="category-option" data-category="lore">ğŸ“– ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</div>
                        <div class="category-option" data-category="combo">ğŸ¯ ã‚³ãƒ³ãƒœ</div>
                        <div class="category-option" data-category="cooldown">â±ï¸ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³</div>
                        <div class="category-option" data-category="proplay">ğŸ† ãƒ—ãƒ­ã‚·ãƒ¼ãƒ³</div>
                        <div class="category-option" data-category="counter">âš”ï¸ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</div>
                        <div class="category-option" data-category="lane">ğŸ—ºï¸ ãƒ¬ãƒ¼ãƒ³åŸºæœ¬</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 0.6rem;" id="hostSettings2">
                    <div class="input-group">
                        <label>å‹åˆ©æ¡ä»¶</label>
                        <select id="winPoints">
                            <option value="7">7pt</option>
                            <option value="15" selected>15pt</option>
                            <option value="25">25pt</option>
                            <option value="40">40pt</option>
                            <option value="60">60pt</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ãŠæ‰‹ä»˜ãè¨±å®¹</label>
                        <select id="mistakesAllowed">
                            <option value="1">1å›</option>
                            <option value="2" selected>2å›</option>
                            <option value="3">3å›</option>
                            <option value="5">5å›</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ãƒŸã‚¹æ™‚æ¸›ç‚¹</label>
                        <select id="missPenalty">
                            <option value="0">0pt</option>
                            <option value="1" selected>1pt</option>
                            <option value="2">2pt</option>
                            <option value="3">3pt</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>å›ç­”æ™‚é–“</label>
                        <select id="answerTime">
                            <option value="10">10ç§’</option>
                            <option value="15">15ç§’</option>
                            <option value="20" selected>20ç§’</option>
                            <option value="30">30ç§’</option>
                            <option value="45">45ç§’</option>
                            <option value="60">60ç§’</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>å‚åŠ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</label>
                    <div style="background: rgba(10, 20, 40, 0.7); border-radius: 10px; padding: 1rem;" id="playersList"></div>
                </div>
                <button class="btn" id="startGameBtn" style="display: block; margin: 1rem auto 0; width: 100%;">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            </div>
        </div>
        <div id="quizScreen" class="screen">
            <div class="quiz-layout">
                <div class="quiz-main">
                    <div class="quiz-header">
                        <div class="round-info">å•é¡Œ <span id="currentRound">1</span></div>
                        <div class="timer" id="timer">30</div>
                    </div>
                    <div class="question-section">
                        <img id="questionImage" class="question-image" style="display: none;">
                        <div class="question-text" id="questionText"></div>
                        <div id="answerSection" class="answer-section">
                            <div class="answer-input-area" id="answerDisplay"></div>
                            <div id="choiceContainer"><div class="choice-grid" id="choiceGrid"></div></div>
                            <div id="comboContainer" style="display: none;">
                                <div class="combo-preview" id="comboPreview">ã‚³ãƒ³ãƒœã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                                <div class="combo-keys" id="comboKeys"></div>
                                <button class="btn submit-combo-btn" id="submitComboBtn" disabled>å›ç­”ç¢ºå®š</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sidebar">
                    <div class="scoreboard">
                        <h3>ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰</h3>
                        <div id="scoreList"></div>
                    </div>
                    <div class="progress-box">
                        <h3>å›ç­”çŠ¶æ³</h3>
                        <div class="progress-count" id="progressCount">0/0äººå®Œäº†</div>
                        <div id="answerProgress"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="resultsScreen" class="screen">
            <div class="results-card">
                <div class="trophy">ğŸ†</div>
                <div class="winner-name" id="winnerName"></div>
                <div id="finalScores" style="margin: 1.5rem 0;"></div>
                <div class="results-actions">
                    <button class="btn btn-secondary" id="continueBtn">ç¶šã‘ã‚‹</button>
                    <button class="btn" id="endBtn">çµ‚äº†</button>
                </div>
            </div>
        </div>
    </div>
    <div id="revealOverlay" class="reveal-overlay" style="display: none;">
        <div class="reveal-title">ğŸ¯ æ­£è§£ç™ºè¡¨</div>
        <div class="reveal-list" id="revealList"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = { databaseURL: "https://lolw-9f44d-default-rtdb.asia-southeast1.firebasedatabase.app" };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(freq, dur, type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = freq; osc.type = type || 'sine';
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.start(audioCtx.currentTime); osc.stop(audioCtx.currentTime + dur);
        }
        function playCorrect() { playSound(523.25, 0.15); setTimeout(() => playSound(659.25, 0.15), 150); setTimeout(() => playSound(783.99, 0.3), 300); }
        function playWrong() { playSound(200, 0.5, 'square'); }
        function playClick() { playSound(600, 0.1); }

        function katakanaToHiragana(str) {
            return str.replace(/[\u30a1-\u30f6]/g, c => String.fromCharCode(c.charCodeAt(0) - 0x60));
        }
        function normalizeText(str) {
            if (!str || typeof str !== 'string') return '';
            let s = katakanaToHiragana(str);
            s = s.replace(/[ãƒ»ï¼ãƒ¼ï¼†\s\u3000]/g, '');
            return s;
        }
        function normalizeComboAnswer(ans) {
            if (!ans || typeof ans !== 'string') return '';
            return ans.replace(/[â†’ï¼\-\s\u3000,ã€ï¼Œ]/g, '').toUpperCase();
        }

        const COMBO_KEYS = ['Q', 'W', 'E', 'R', 'AA'];
        let questionDB = { champion: [], skill: [], lore: [], combo: [], cooldown: [], proplay: [], counter: [], lane: [] };
        async function loadQuestionData() {
            try {
                const [champRes, extraRes] = await Promise.all([fetch('questions.json'), fetch('questions-extra.json')]);
                if (!champRes.ok || !extraRes.ok) throw new Error();
                const champData = await champRes.json();
                const extraData = await extraRes.json();
                questionDB.champion = (champData.champions || []).map(c => ({
                    q: 'ã“ã®ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ã¯èª°ã§ã™ã‹', a: katakanaToHiragana(c.katakana || c.jp || ''), championId: c.id
                }));
                ['skill', 'lore', 'cooldown', 'proplay', 'counter', 'lane'].forEach(cat => { questionDB[cat] = extraData[cat] || []; });
                questionDB.combo = (extraData.combo || []).filter(q => !/[FD]/.test(String(q.a || '')));
            } catch (e) {
                alert('å•é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚questions.json ã¨ questions-extra.json ã‚’åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ã„ã¦ãã ã•ã„ã€‚');
            }
        }

        let state = { roomCode: null, playerName: null, isHost: false, currentAnswer: '', comboSequence: [],
            hasAnswered: false, isSuspended: false, unsubscribe: null, lastQuestionKey: null };
        let currentRoomData = null;
        let timerInterval = null;
        let scoreCalculated = false;

        function generateRoomCode() {
            let code = '';
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            return code;
        }
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            dot.classList.toggle('disconnected', !connected);
            text.textContent = connected ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'åˆ‡æ–­';
        }

        async function createRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) { alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const roomCode = generateRoomCode();
            state.roomCode = roomCode; state.playerName = playerName; state.isHost = true;
            await set(ref(database, `rooms/${roomCode}`), {
                host: playerName, players: { [playerName]: { name: playerName, isHost: true } },
                categories: ['champion'], winPoints: 15, mistakesAllowed: 2, missPenalty: 1, answerTime: 20,
                gameStarted: false, currentRound: 0, currentQuestion: null, phase: 'answering',
                scores: { [playerName]: 0 }, mistakes: { [playerName]: 0 }, suspended: { [playerName]: false },
                usedQuestions: [], playerAnswers: {}, scoreCalculated: false, timerStart: null, timestamp: Date.now()
            });
            showLobby();
            listenToRoom();
        }

        function showJoinRoom() { showScreen('joinScreen'); }

        async function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!playerName) { alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (!roomCode || roomCode.length !== 6) { alert('6æ¡ã®ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const snapshot = await get(ref(database, `rooms/${roomCode}`));
            if (!snapshot.exists()) { alert('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
            const roomData = snapshot.val();
            if (roomData.players && roomData.players[playerName]) { alert('ã“ã®åå‰ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™'); return; }
            state.roomCode = roomCode; state.playerName = playerName; state.isHost = false;
            await update(ref(database, `rooms/${roomCode}`), {
                [`players/${playerName}`]: { name: playerName, isHost: false },
                [`scores/${playerName}`]: 0, [`mistakes/${playerName}`]: 0, [`suspended/${playerName}`]: false,
                timestamp: Date.now()
            });
            showLobby();
            listenToRoom();
        }

        function showHome() { showScreen('homeScreen'); }

        function showLobby() {
            showScreen('lobbyScreen');
            document.getElementById('roomCode').textContent = state.roomCode;
            const host = state.isHost;
            document.getElementById('hostSettings').style.display = host ? 'block' : 'none';
            document.getElementById('hostSettings2').style.display = host ? 'grid' : 'none';
            document.getElementById('startGameBtn').style.display = host ? 'block' : 'none';
            updateConnectionStatus(true);
        }

        function listenToRoom() {
            const roomRef = ref(database, `rooms/${state.roomCode}`);
            state.unsubscribe = onValue(roomRef, (snapshot) => {
                if (!snapshot.exists()) { updateConnectionStatus(false); return; }
                updateConnectionStatus(true);
                currentRoomData = snapshot.val();
                if (currentRoomData.players) updatePlayersList(Object.values(currentRoomData.players));
                const quizActive = document.getElementById('quizScreen').classList.contains('active');
                if (currentRoomData.gameStarted && !quizActive) {
                    showScreen('quizScreen');
                    if (state.isHost && !currentRoomData.currentQuestion) setTimeout(() => nextQuestion(currentRoomData), 500);
                }
                if (quizActive) syncGameState(currentRoomData);
                if (currentRoomData.showResults) showResults(currentRoomData);
            });
        }

        function updatePlayersList(players) {
            const list = document.getElementById('playersList');
            list.innerHTML = '';
            players.forEach(p => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; padding: 0.6rem; margin-bottom: 0.4rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 3px solid ' + (p.isHost ? 'var(--gold)' : 'var(--blue)');
                div.innerHTML = `<div style="width: 35px; height: 35px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; color: var(--dark-blue); margin-right: 0.8rem;">${p.name.charAt(0).toUpperCase()}</div>` +
                    `<div style="flex: 1; font-weight: 700; font-size: 0.9rem;">${p.name}</div>` +
                    (p.isHost ? '<span style="background: var(--gold); color: var(--dark-blue); padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 700;">HOST</span>' : '');
                list.appendChild(div);
            });
        }

        document.getElementById('copyCodeBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(state.roomCode);
            const btn = document.getElementById('copyCodeBtn');
            const orig = btn.textContent;
            btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†';
            setTimeout(() => btn.textContent = orig, 2000);
        });

        document.getElementById('categoryGrid').addEventListener('click', e => {
            if (!state.isHost) return;
            const opt = e.target.closest('.category-option');
            if (opt) opt.classList.toggle('selected');
        });

        async function startGameFromLobby() {
            if (!state.isHost) return;
            const selected = [];
            document.querySelectorAll('.category-option.selected').forEach(o => selected.push(o.getAttribute('data-category')));
            if (selected.length === 0) { alert('å°‘ãªãã¨ã‚‚1ã¤ã®å‡ºé¡Œç¯„å›²ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            const winPoints = parseInt(document.getElementById('winPoints').value);
            const mistakesAllowed = parseInt(document.getElementById('mistakesAllowed').value);
            const missPenalty = parseInt(document.getElementById('missPenalty').value);
            const answerTime = parseInt(document.getElementById('answerTime').value);
            await update(ref(database, `rooms/${state.roomCode}`), {
                categories: selected, winPoints, mistakesAllowed, missPenalty, answerTime,
                gameStarted: true, currentRound: 1, usedQuestions: [], scoreCalculated: false, phase: 'answering',
                playerAnswers: {}, timestamp: Date.now()
            });
        }

        function getRandomUnusedQuestion(roomData) {
            let all = [];
            (roomData.categories || []).forEach(cat => { if (questionDB[cat]) all = all.concat(questionDB[cat]); });
            const used = roomData.usedQuestions || [];
            const avail = all.filter(q => !used.includes(JSON.stringify({ q: q.q, a: q.a })));
            return avail.length ? avail[Math.floor(Math.random() * avail.length)] : all[Math.floor(Math.random() * all.length)];
        }

        async function nextQuestion(roomData) {
            if (!state.isHost || !currentRoomData) return;
            const scores = roomData.scores || {};
            if (Object.values(scores).some(s => s >= (roomData.winPoints || 10))) {
                await update(ref(database, `rooms/${state.roomCode}`), { showResults: true, timestamp: Date.now() });
                return;
            }
            const question = getRandomUnusedQuestion(roomData);
            const key = JSON.stringify({ q: question.q, a: question.a });
            const used = [...(roomData.usedQuestions || []), key];
            const answerTime = roomData.answerTime || 30;
            await update(ref(database, `rooms/${state.roomCode}`), {
                currentQuestion: question, usedQuestions: used, playerAnswers: {},
                scoreCalculated: false, phase: 'answering', timerStart: Date.now(), timestamp: Date.now()
            });
            scoreCalculated = false;
            state.lastQuestionKey = null;
            document.getElementById('revealOverlay').style.display = 'none';
            startTimer(answerTime);
        }

        function displayQuestion(question) {
            if (!question) return;
            const qKey = JSON.stringify({ q: question.q, a: question.a });
            if (state.lastQuestionKey === qKey && !state.hasAnswered) return;
            state.lastQuestionKey = qKey;
            document.getElementById('questionText').textContent = question.q;
            const imgEl = document.getElementById('questionImage');
            if (question.championId) {
                imgEl.src = `https://ddragon.leagueoflegends.com/cdn/img/champion/splash/${question.championId}_0.jpg`;
                imgEl.style.display = 'block';
            } else imgEl.style.display = 'none';
            state.currentAnswer = ''; state.comboSequence = []; state.hasAnswered = false;
            const isCombo = question.a && /[QWERADF]|AA|â†’|,/.test(String(question.a));
            const rd = currentRoomData || {};
            const isSuspended = rd.suspended?.[state.playerName];
            const showAnswerUI = !isSuspended && !rd.scoreCalculated;
            document.getElementById('choiceContainer').style.display = isCombo ? 'none' : 'block';
            document.getElementById('comboContainer').style.display = isCombo ? 'block' : 'none';
            document.getElementById('answerSection').style.pointerEvents = showAnswerUI ? 'auto' : 'none';
            document.getElementById('answerSection').style.opacity = showAnswerUI ? '1' : '0.6';
            if (isCombo) {
                renderComboUI();
            } else {
                generateChoices(question);
            }
        }

        function renderComboUI() {
            const keysDiv = document.getElementById('comboKeys');
            const previewDiv = document.getElementById('comboPreview');
            keysDiv.innerHTML = '';
            COMBO_KEYS.forEach(k => {
                const btn = document.createElement('button');
                btn.className = 'combo-key-btn';
                btn.textContent = k;
                btn.onclick = () => {
                    if (state.hasAnswered) return;
                    playClick();
                    state.comboSequence.push(k);
                    updateComboPreview();
                    document.getElementById('submitComboBtn').disabled = state.comboSequence.length === 0;
                };
                keysDiv.appendChild(btn);
            });
            const clearBtn = document.createElement('button');
            clearBtn.className = 'btn btn-secondary';
            clearBtn.textContent = 'ã‚¯ãƒªã‚¢';
            clearBtn.style.marginLeft = '0.5rem';
            clearBtn.onclick = () => {
                state.comboSequence = [];
                updateComboPreview();
                document.getElementById('submitComboBtn').disabled = true;
            };
            keysDiv.appendChild(clearBtn);
            state.comboSequence = [];
            updateComboPreview();
            document.getElementById('submitComboBtn').disabled = true;
        }

        function updateComboPreview() {
            const d = document.getElementById('comboPreview');
            if (state.comboSequence.length === 0) {
                d.textContent = 'ã‚³ãƒ³ãƒœã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                d.innerHTML = 'ã‚³ãƒ³ãƒœã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
            } else {
                d.innerHTML = state.comboSequence.map(k => `<span class="combo-preview-item">${k}</span>`).join(' â†’ ');
            }
        }

        function generateChoices(question) {
            const grid = document.getElementById('choiceGrid');
            grid.innerHTML = '';
            if (question.choices) {
                question.choices.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.textContent = c;
                    btn.onclick = () => { if (!state.hasAnswered) selectChoice(c, true); };
                    grid.appendChild(btn);
                });
            } else if (question.championId) {
                generateHiraganaChoices(question.a, 0);
            }
        }

        function generateHiraganaChoices(answer, position) {
            if (position >= answer.length) return;
            const correctChar = answer.charAt(position);
            const allChars = 'ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“ãŒããã’ã”ã–ã˜ãšãœãã ã¢ã¥ã§ã©ã°ã³ã¶ã¹ã¼ã±ã´ã·ãºã½ã‚ƒã‚…ã‚‡ã£ãƒ¼';
            const choices = [correctChar];
            while (choices.length < 4) {
                const r = allChars.charAt(Math.floor(Math.random() * allChars.length));
                if (!choices.includes(r)) choices.push(r);
            }
            for (let i = choices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [choices[i], choices[j]] = [choices[j], choices[i]];
            }
            const grid = document.getElementById('choiceGrid');
            grid.innerHTML = '';
            choices.forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = c;
                btn.onclick = () => {
                    if (state.hasAnswered) return;
                    playClick();
                    if (c !== correctChar) {
                        state.currentAnswer += c;
                        document.getElementById('answerDisplay').textContent = state.currentAnswer;
                        submitAnswer(answer);
                        return;
                    }
                    state.currentAnswer += c;
                    document.getElementById('answerDisplay').textContent = state.currentAnswer;
                    if (state.currentAnswer.length >= answer.length) submitAnswer(answer);
                    else generateHiraganaChoices(answer, state.currentAnswer.length);
                };
                grid.appendChild(btn);
            });
        }

        function selectChoice(choice, isFinal) {
            if (state.hasAnswered) return;
            playClick();
            const question = currentRoomData?.currentQuestion;
            if (!question) return;
            state.currentAnswer = choice;
            document.getElementById('answerDisplay').textContent = choice;
            submitAnswer(question.a);
        }

        document.getElementById('submitComboBtn').addEventListener('click', () => {
            if (state.hasAnswered || !currentRoomData?.currentQuestion) return;
            const q = currentRoomData.currentQuestion;
            state.currentAnswer = state.comboSequence.join(',');
            submitAnswer(q.a);
        });

        async function submitAnswer(correctAnswer) {
            if (state.hasAnswered) return;
            state.hasAnswered = true;
            const roomData = currentRoomData;
            if (!roomData) return;
            const question = roomData.currentQuestion;
            let correct = false;
            if (question.a && /[QWERADF]|AA|â†’|,/.test(String(question.a))) {
                const userSeq = normalizeComboAnswer(state.currentAnswer);
                const correctSeq = normalizeComboAnswer(correctAnswer);
                correct = userSeq === correctSeq;
            } else {
                correct = normalizeText(state.currentAnswer) === normalizeText(correctAnswer);
            }
            const timeLeft = roomData.timerStart ? Math.max(0, (roomData.answerTime || 20) - Math.floor((Date.now() - roomData.timerStart) / 1000)) : 0;
            const totalTime = roomData.answerTime || 20;
            const speedBonus = correct ? Math.floor((timeLeft / totalTime) * 4) : 0;
            const baseScore = correct ? 2 : 0;
            const addScore = correct ? baseScore + speedBonus : 0;
            const newMistakes = !correct ? (roomData.mistakes?.[state.playerName] || 0) + 1 : (roomData.mistakes?.[state.playerName] || 0);
            const missPenalty = roomData.missPenalty ?? 1;
            const penaltyValue = !correct ? missPenalty : 0;
            const updates = {
                [`playerAnswers/${state.playerName}`]: { answer: state.currentAnswer, correct, timestamp: Date.now(), addScore, penaltyValue },
                [`mistakes/${state.playerName}`]: newMistakes,
                timestamp: Date.now()
            };
            await update(ref(database, `rooms/${state.roomCode}`), updates);
            document.querySelectorAll('.choice-btn').forEach(b => b.disabled = true);
            document.querySelectorAll('.combo-key-btn').forEach(b => b.disabled = true);
            document.getElementById('submitComboBtn').disabled = true;
            if (correct) { playCorrect(); document.body.classList.add('flash-correct'); setTimeout(() => document.body.classList.remove('flash-correct'), 500); }
            else playWrong();
        }

        function startTimer(seconds) {
            const start = Date.now();
            let timeLeft = seconds;
            const timerEl = document.getElementById('timer');
            timerEl.textContent = timeLeft;
            timerEl.classList.remove('warning');
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft = Math.max(0, seconds - Math.floor((Date.now() - start) / 1000));
                timerEl.textContent = timeLeft;
                if (timeLeft <= 10) timerEl.classList.add('warning');
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (state.isHost && currentRoomData && !currentRoomData.scoreCalculated) {
                        showRevealAndNext();
                    }
                }
            }, 200);
        }

        async function showRevealAndNext() {
            const roomData = currentRoomData;
            if (!roomData || !state.isHost) return;
            if (scoreCalculated) return;
            scoreCalculated = true;
            clearInterval(timerInterval);
            await calculateScores(roomData);
            const answers = roomData.playerAnswers || {};
            const players = Object.values(roomData.players || {});
            const list = document.getElementById('revealList');
            list.innerHTML = '';
            players.forEach(p => {
                const ans = answers[p.name];
                const div = document.createElement('div');
                if (ans) {
                    div.className = 'reveal-item ' + (ans.correct ? 'correct' : 'incorrect');
                    div.innerHTML = `<span>${p.name}</span><span>${ans.correct ? 'âœ“ æ­£è§£' : 'âœ— ä¸æ­£è§£'}</span>`;
                } else {
                    div.className = 'reveal-item incorrect';
                    div.innerHTML = `<span>${p.name}</span><span>æœªå›ç­”</span>`;
                }
                list.appendChild(div);
            });
            document.getElementById('revealOverlay').style.display = 'flex';
            setTimeout(async () => {
                document.getElementById('revealOverlay').style.display = 'none';
                const nextRoomData = { ...roomData, currentRound: (roomData.currentRound || 1) + 1 };
                await update(ref(database, `rooms/${state.roomCode}`), { currentRound: nextRoomData.currentRound, phase: 'answering', timestamp: Date.now() });
                await nextQuestion(nextRoomData);
            }, 3000);
        }

        function syncGameState(roomData) {
            if (!roomData.currentQuestion) return;
            currentRoomData = roomData;
            document.getElementById('currentRound').textContent = roomData.currentRound || 1;
            const totalTime = roomData.answerTime || 30;
            const start = roomData.timerStart || 0;
            if (start && !state.isHost) {
                const elapsed = Math.floor((Date.now() - start) / 1000);
                const left = Math.max(0, totalTime - elapsed);
                document.getElementById('timer').textContent = left;
                document.getElementById('timer').classList.toggle('warning', left <= 10);
            }
            state.isSuspended = roomData.suspended?.[state.playerName];
            displayQuestion(roomData.currentQuestion);
            const players = Object.values(roomData.players || {});
            const answers = roomData.playerAnswers || {};
            const answeredCount = players.filter(p => answers[p.name]).length;
            document.getElementById('progressCount').textContent = `${answeredCount}/${players.length}äººå®Œäº†`;
            const phase = roomData.phase || 'answering';
            const progressDiv = document.getElementById('answerProgress');
            progressDiv.innerHTML = '';
            if (phase === 'reveal' || roomData.scoreCalculated) {
                players.forEach(p => {
                    const ans = answers[p.name];
                    const div = document.createElement('div');
                    div.className = 'progress-item ' + (ans?.correct ? 'correct' : (ans ? 'incorrect' : 'waiting'));
                    const badge = ans?.correct ? 'correct' : (ans ? 'incorrect' : 'waiting');
                    const text = ans?.correct ? 'âœ“ æ­£è§£' : (ans ? 'âœ— ä¸æ­£è§£' : 'æœªå›ç­”');
                    div.innerHTML = `<span class="progress-name">${p.name}</span><span class="progress-badge ${badge}">${text}</span>`;
                    progressDiv.appendChild(div);
                });
            } else {
                players.forEach(p => {
                    const hasAnswered = !!answers[p.name];
                    const div = document.createElement('div');
                    div.className = 'progress-item waiting';
                    div.innerHTML = `<span class="progress-name">${p.name}</span><span class="progress-badge waiting">${hasAnswered ? 'å®Œäº†' : 'å›ç­”ä¸­...'}</span>`;
                    progressDiv.appendChild(div);
                });
            }
            updateScoreboard(roomData);
            const allDone = players.every(p => answers[p.name]);
            const timerEnd = roomData.timerStart && (Date.now() - roomData.timerStart) >= ((roomData.answerTime || 30) * 1000);
            if ((allDone || timerEnd) && state.isHost && !roomData.scoreCalculated && Object.keys(answers).length > 0) {
                showRevealAndNext();
            }
        }

        async function calculateScores(roomData) {
            if (scoreCalculated) return;
            scoreCalculated = true;
            await update(ref(database, `rooms/${state.roomCode}`), { scoreCalculated: true, phase: 'reveal', timestamp: Date.now() });
            const answers = roomData.playerAnswers || {};
            const scores = { ...(roomData.scores || {}) };
            const mistakes = roomData.mistakes || {};
            const mistakesAllowed = roomData.mistakesAllowed || 2;
            const suspended = { ...(roomData.suspended || {}) };
            Object.entries(answers).forEach(([name, ans]) => {
                if (ans.correct) scores[name] = (scores[name] || 0) + (ans.addScore ?? 2);
            });
            const missPenalty = roomData.missPenalty ?? 1;
            Object.entries(answers).forEach(([name, ans]) => {
                if (!ans.correct) {
                    const penalty = ans.penaltyValue ?? missPenalty;
                    scores[name] = Math.max(0, (scores[name] || 0) - penalty);
                    if (mistakes[name] > mistakesAllowed) suspended[name] = true;
                }
            });
            Object.keys(suspended).forEach(k => { suspended[k] = suspended[k] || false; });
            await update(ref(database, `rooms/${state.roomCode}`), { scores, suspended, timestamp: Date.now() });
        }

        function updateScoreboard(roomData) {
            const list = document.getElementById('scoreList');
            list.innerHTML = '';
            const players = Object.values(roomData.players || {}).sort((a, b) =>
                (roomData.scores?.[b.name] || 0) - (roomData.scores?.[a.name] || 0));
            const mistakes = roomData.mistakes || {};
            const suspended = roomData.suspended || {};
            players.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'score-item' + (i === 0 ? ' first' : '') + (suspended[p.name] ? ' suspended' : '');
                div.innerHTML = `<span class="score-name">${p.name}${suspended[p.name] ? ' ğŸš«' : ''}</span><span class="score-points">${roomData.scores?.[p.name] || 0}pt</span>`;
                if (mistakes[p.name] > 0 && !suspended[p.name]) {
                    const m = document.createElement('div');
                    m.className = 'mistakes-info';
                    m.textContent = `ãŠæ‰‹ä»˜ã: ${mistakes[p.name]}/${roomData.mistakesAllowed || 2}`;
                    div.appendChild(m);
                }
                list.appendChild(div);
            });
        }

        function showResults(roomData) {
            showScreen('resultsScreen');
            const players = Object.values(roomData.players || {}).sort((a, b) =>
                (roomData.scores?.[b.name] || 0) - (roomData.scores?.[a.name] || 0));
            document.getElementById('winnerName').textContent = players.length ? `ğŸ‰ ${players[0].name} å„ªå‹! ğŸ‰` : '';
            const fs = document.getElementById('finalScores');
            fs.innerHTML = '';
            players.forEach((p, i) => {
                const d = document.createElement('div');
                d.style.cssText = 'font-size: 1.1rem; padding: 0.8rem; margin: 0.4rem 0; background: rgba(255,255,255,0.05); border-radius: 8px;';
                d.innerHTML = `<span style="display: inline-block; width: 35px; height: 35px; background: var(--gold); color: var(--dark-blue); border-radius: 50%; line-height: 35px; margin-right: 0.8rem; font-weight: 700; text-align: center;">${i + 1}</span>${p.name}: ${roomData.scores?.[p.name] || 0}pt`;
                fs.appendChild(d);
            });
            playCorrect();
            setTimeout(playCorrect, 300);
            setTimeout(playCorrect, 600);
        }

        async function continueGame() {
            if (!state.isHost) return;
            const roomData = currentRoomData;
            if (!roomData) return;
            const players = Object.values(roomData.players || {});
            const resetScores = {}; const resetMistakes = {}; const resetSuspended = {};
            players.forEach(p => {
                resetScores[p.name] = 0; resetMistakes[p.name] = 0; resetSuspended[p.name] = false;
            });
            await update(ref(database, `rooms/${state.roomCode}`), {
                scores: resetScores, mistakes: resetMistakes, suspended: resetSuspended,
                showResults: false, gameStarted: true, currentRound: 1, usedQuestions: [],
                playerAnswers: {}, scoreCalculated: false, phase: 'answering', timestamp: Date.now()
            });
            showScreen('quizScreen');
            const baseData = { ...roomData, scores: resetScores, mistakes: resetMistakes, suspended: resetSuspended, currentRound: 1, usedQuestions: [], playerAnswers: {} };
            setTimeout(() => nextQuestion(baseData), 500);
        }

        function endGame() {
            if (state.unsubscribe) state.unsubscribe();
            location.reload();
        }

        document.getElementById('createRoomBtn').addEventListener('click', createRoom);
        document.getElementById('joinRoomBtn').addEventListener('click', showJoinRoom);
        document.getElementById('backToHomeBtn').addEventListener('click', showHome);
        document.getElementById('joinBtn').addEventListener('click', joinRoom);
        document.getElementById('startGameBtn').addEventListener('click', startGameFromLobby);
        document.getElementById('continueBtn').addEventListener('click', continueGame);
        document.getElementById('endBtn').addEventListener('click', endGame);
        loadQuestionData();
    </script>
</body>
</html>
